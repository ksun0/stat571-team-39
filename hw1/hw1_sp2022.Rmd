---
title: " Modern Data Mining, HW 1"
author:
- Kevin Sun
- William Walsh
- Hanson Wang
date: 'Due: 11:59PM,  Jan. 30th, 2021'
output:
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: '4'
  html_document:
    code_folding: show
    highlight: haddock
    number_sections: yes
    theme: lumen
    toc: yes
    toc_depth: 4
    toc_float: yes
  word_document:
    toc: yes
    toc_depth: '4'
urlcolor: blue
---


```{r setup, include=FALSE}
# knitr::opts_chunk$set(echo = FALSE, results = "hide", fig.width=8, fig.height=4)
knitr::opts_chunk$set(echo = TRUE, results = "show", fig.width=8, fig.height=4)
options(scipen = 0, digits = 3)  # controls base R output
# check if you have ISLR package, if not, install it
if(!require('pacman')) {install.packages('pacman')}
pacman::p_load(ISLR, readxl, tidyverse, magrittr, dplyr, ggplot2)
```


\pagebreak

# Overview

This is a fast-paced course that covers a lot of material. There will be a large amount of references. You may need to do your own research to fill in the gaps in between lectures and homework/projects. It is impossible to learn data science without getting your hands dirty. Please budget your time evenly. Last-minute work ethic will not work for this course. 

Homework in this course is different from your usual homework assignment as a typical student. Most of the time, they are built over real case studies.  While you will be applying methods covered in lectures, you will also find that extra teaching materials appear here.  The focus will be always on the goals of the study, the usefulness of the data gathered, and the limitations in any conclusions you may draw. Always try to challenge your data analysis in a critical way. Frequently, there are no unique solutions. 

Case studies in each homework can be listed as your data science projects (e.g. on your CV) where you see fit. 



## Objectives 

- Get familiar with `R-studio` and `RMarkdown`
- Hands-on R 
- Learn data science essentials 
    - gather data
    - clean data
    - summarize data 
    - display data
    - conclusion
- Packages
    - `dplyr`
    - `ggplot`

##  Instructions

- **Homework assignments can be done in a group consisting of up to three members**. Please find your group members as soon as possible and register your group on our Canvas site.

- **All work submitted should be completed in the R Markdown format.** You can find a cheat sheet for R Markdown [here](https://github.com/rstudio/cheatsheets/raw/master/rmarkdown-2.0.pdf). For those who have never used it before, we urge you to start this homework as soon as possible. 

- **Submit the following files, one submission for each group:**  (1) Rmd file, (2) a compiled PDF or HTML version, and (3) all necessary data files if different from our source data. You may directly edit this .rmd file to add your answers. If you intend to work on the problems separately within your group, compile your answers into one Rmd file before submitting. We encourage that you at least attempt each problem by yourself before working with your teammates. Additionally, ensure that you can 'knit' or compile your Rmd file. It is also likely that you need to configure Rstudio to properly convert files to PDF. [**These instructions**](http://kbroman.org/knitr_knutshell/pages/latex.html#converting-knitrlatex-to-pdf) might be helpful.

- In general, be as concise as possible while giving a fully complete answer to each question. All necessary datasets are available in this homework folder on Canvas. Make sure to document your code with comments (written on separate lines in a code chunk using a hashtag `#` before the comment) so the teaching fellows can follow along. R Markdown is particularly useful because it follows a 'stream of consciousness' approach: as you write code in a code chunk, make sure to explain what you are doing outside of the chunk. 

- A few good or solicited submissions will be used as sample solutions. When those are released, make sure to compare your answers and understand the solutions.


## Review materials

- Study Advanced R Tutorial (to include `dplyr` and `ggplot`)
- Study lecture 1: Data Acquisition and EDA


# Case study 1: Audience Size

How successful is the Wharton Talk Show [Business Radio Powered by the Wharton School](https://businessradio.wharton.upenn.edu/)  


**Background:** Have you ever listened to [SiriusXM](https://www.siriusxm.com/)? Do you know there is a **Talk Show** run by Wharton professors in Sirius Radio?  Wharton launched a talk show called [Business Radio Powered by the Wharton School](https://businessradio.wharton.upenn.edu/) through the Sirius Radio station in January of 2014. Within a short period of time the general reaction seemed to be overwhelmingly positive. To find out the audience size for the show, we designed a survey and collected a data set via MTURK in May of 2014. Our goal was to **estimate the audience size**. There were 51.6 million Sirius Radio listeners then. One approach is to estimate the proportion of the Wharton listeners to that of the Sirius listeners, $p$, so that we will come up with an audience size estimate of approximately 51.6 million times $p$. 

To do so, we launched a survey via Amazon Mechanical Turk ([MTurk](https://www.mturk.com/)) on May 24, 2014 at an offered price of \$0.10 for each answered survey.  We set it to be run for 6 days with a target maximum sample size of 2000 as our goal. Most of the observations came in within the first two days. The main questions of interest are "Have you ever listened to Sirius Radio" and "Have you ever listened to Sirius Business Radio by Wharton?". A few demographic features used as control variables were also collected; these include Gender, Age and Household Income.  

We requested that only people in United States answer the questions. Each person can only fill in the questionnaire once to avoid duplicates. Aside from these restrictions, we opened the survey to everyone in MTurk with a hope that the sample would be more randomly chosen. 

The raw data is stored as `Survey_results_final.csv` on Canvas.

```{r librarysetup}
library(dplyr)
library(ggplot2)
library(dplyr)
library(grid)
library(ggplot2)
library(lattice)
```

## Data preparation

i. We need to clean and select only the variables of interest. 

Select only the variables Age, Gender, Education Level, Household Income in 2013, Sirius Listener?, Wharton Listener? and Time used to finish the survey.

Change the variable names to be "age", "gender", "education", "income", "sirius", "wharton", "worktime".

ii. Handle missing/wrongly filled values of the selected variables

As in real world data with user input, the data is incomplete, with missing values, and has incorrect responses. There is no general rule for dealing with these problems beyond “use common sense.” In whatever case, explain what the problems were and how you addressed them. Be sure to explain your rationale for your chosen methods of handling issues with the data. Do not use Excel for this, however tempting it might be.

Tip: Reflect on the reasons for which data could be wrong or missing. How would you address each case? For this homework, if you are trying to predict missing values with regression, you are definitely overthinking. Keep it simple.
```{r question1.1, echo=TRUE, message=FALSE, warning=FALSE}

rawdatasurvey <- read.csv("data/Survey_results_final.csv", header=T, stringsAsFactors = FALSE)
keptvars <- c("Answer.Age", "Answer.Gender", "Answer.Education", 
              "Answer.HouseHoldIncome", "Answer.Sirius.Radio",
              "Answer.Wharton.Radio","WorkTimeInSeconds")
datasurvey <- rawdatasurvey[keptvars]

datasurvey <- datasurvey %>% rename(age = Answer.Age, gender = Answer.Gender, 
                                    education = Answer.Education, income = Answer.HouseHoldIncome,
                                    sirius = Answer.Sirius.Radio, wharton = Answer.Wharton.Radio,
                                    worktime = WorkTimeInSeconds)

# remove people too young or old, non numeric ages, too fast submissions low-quality, remove no income, no responce to key survey question, and people that listen on other platforms

datasurvey <- mutate(datasurvey, age = as.numeric(age))
datasurvey <- filter(datasurvey, age >= 10 & age <= 110 & worktime >= 7 & !is.na(age))
datasurvey <- datasurvey[-which(datasurvey$income == ""), ]
datasurvey <- datasurvey[-which(datasurvey$gender == ""), ]
datasurvey <- datasurvey[-which(datasurvey$sirius == ""), ]
datasurvey <- datasurvey[-which(datasurvey$wharton == ""), ] 	
datasurvey <- datasurvey[-which(datasurvey$education == "select one"), ]
datasurvey <- datasurvey[-which(datasurvey$wharton == "Yes" & datasurvey$sirius == "No"), ]
```
## Data preperation RESPONSE

To clean the data, people too old (>110) and too young (<10) were removed. Furthermore, people without a numeric age were removed. Samples that were too quick (<7seconds) were also removed due to the likely low-quality of their responses. Incomplete entries in the other columns were removed, in addition to people that claimed to listen to the Wharton station without listening to SiriusXM.

```{r question1, echo=TRUE, message=FALSE, warning=FALSE}

summary(datasurvey)

```


iii. Brief summary 

Write a brief report to summarize all the variables collected. Include both summary statistics (including sample size) and graphical displays such as histograms or bar charts where appropriate. Comment on what you have found from this sample. (For example - it's very interesting to think about why would one work for a job that pays only 10cents/each survey? Who are those survey workers? The answer may be interesting even if it may not directly relate to our goal.)

1. Sample Size = 1723


```{r question1plots, echo=TRUE, message=FALSE, warning=FALSE}
p1 <- ggplot(datasurvey) +
geom_histogram(aes(x = age), count = 5) +
labs( title = "Histogram of Age", x = "Age" , y = "Frequency", fill= "blue")

p1 + theme(text = element_text(size = 12))

incomedf <- as.data.frame(table(datasurvey$income))
incomedf <- incomedf[c(6, 1:5), ] # new order


incomedf <- as.data.frame(table(datasurvey$income))
incomedf <- incomedf %>% rename(income = Var1, count = Freq)
incomedf <- incomedf[c(6, 1:5), ] # new order
incomedf <- incomedf %>% mutate(percent = count / sum(incomedf$count))
incomedf

genderdf <- as.data.frame(table(datasurvey$gender))
genderdf <- genderdf %>% rename(gender = Var1, count = Freq)
genderdf <- genderdf %>% mutate(percent = count / sum(genderdf$count))
genderdf


medianage <- median(datasurvey$age)
medianage

edudf <- as.data.frame(table(datasurvey$education))
edudf <- edudf %>% rename(education = Var1, count = Freq)
edudf <- edudf %>% mutate(percent = count / sum(genderdf$count))
edudf


```


```{r whartonreach, echo=TRUE, message=FALSE, warning=FALSE}



genderratedf <-datasurvey %>%
  group_by(gender) %>%
  summarise(
    count = sum(age != 0),
    sirius_count = sum(sirius == 'Yes'),
    wharton_count = sum(sirius == 'Yes' & wharton == 'Yes'))

incomeratedf <-datasurvey %>%
  group_by(income) %>%
  summarise(
    count = sum(age != 0),
    sirius_count = sum(sirius == 'Yes'),
    wharton_count = sum(sirius == 'Yes' & wharton == 'Yes'))

ageratedf <-datasurvey %>%
  group_by(gr=cut(age, breaks= seq(0, 100, by = 10)) ) %>% 
     summarise(count= n(), sirius_count = sum(sirius == 'Yes'),
    wharton_count = sum(sirius == 'Yes' & wharton == 'Yes'))%>%
     arrange(as.numeric(gr))

genderratedf <- genderratedf %>% mutate(siriuspct = sirius_count / count)
genderratedf <- genderratedf %>% mutate(whartonshare = wharton_count / sirius_count)
genderratedf

incomeratedf <- incomeratedf %>% mutate(siriuspct = sirius_count / count)
incomeratedf <- incomeratedf[c(6, 1:5), ] # new order
incomeratedf <- incomeratedf %>% mutate(whartonshare = wharton_count / sirius_count)
incomeratedf


ageratedf <- ageratedf %>% mutate(siriuspct = sirius_count / count)
ageratedf <- ageratedf %>% mutate(whartonshare = wharton_count / sirius_count)
ageratedf

#sirius reaches femals and males equally if similar age distributions
#looks like way more men listen to wharton than females
whartonspct <- sum(incomeratedf$wharton_count) / sum(incomeratedf$count)
whartonspct

whartonpctofsirius <- sum(incomeratedf$wharton_count) / sum(incomeratedf$sirius_count)
whartonpctofsirius

```


## Sample properties

The population from which the sample is drawn determines where the results of our analysis can be applied or generalized. We include some basic demographic information for the purpose of identifying sample bias, if any exists. Combine our data and the general population distribution in age, gender and income to try to characterize our sample on hand.

i. Does this sample appear to be a random sample from the general population of the USA?
ii. Does this sample appear to be a random sample from the MTURK population?

Note: You can not provide evidence by simply looking at our data here. For example, you need to find distribution of education in our age group in US to see if the two groups match in distribution. You may need to gather some background information about the MTURK population to have a slight sense if this particular sample seem to a random sample from there... Please do not spend too much time gathering evidence. 

## (2.2) Sample properties RESPONSE

From visual inspection of the histogram of survey respondent ages, the sample from this survey is skewed towards younger people. The median age of people in America in 2014 was 37.4 years [1], while the median age of survey respondents was only 28, nearly ten years younger. Thus, this survey population does not represent a random sample of the general US population with respect to age. From inspection of the gender breakdown of this population, males are heavilly over represented. According to the US Census Bureau, the general US population is only 49.2% male-- in this survey, respondents were over 57% male. Due to an over representation of men, this population is not a random sample of the US population.[2] Furthermore, this sample skews to lower-income people. According to the US Census Bureau, more than 10% of American Households had incomes above 157,500-- less than 3% of sample data came from households with income above 150,000.[3] Thus, the data set is not a random sample of American Households and skews towards households with less income.

According to CloudResearch, 57.5% of participants in MTURK are female, in our dataset 57% of survey responses came from men. Clearly, our data set is not a random sample of the Amazom MTURK population. [5] Income wise, this data set appears to be close to a random sample of the MTRUK data set income wise, with the largest discrepancy coming in the 150k+ income bucket, MTRURK is about 5%, this data is around 3%. Overall, income appears to be the same across MTRUK and the sample. The age distribution appears to match the Amazon MTURK population closer than the overall US population, with the majority of respondents under 40. The median age of MTURK as a whole is a bit higher than 28, our median, according to a graph on CloudResearch [5]. Overall, the sample appears to be a bit younger and more male than MTRUK as a whole.



Sources: 
1. https://www.census.gov/data/developers/data-sets/acs-5year.html
2. https://www.census.gov/prod/cen2010/briefs/c2010br-03.pdf
3. https://www.census.gov/library/visualizations/2015/demo/distribution-of-household-income--2014.html
5. https://www.cloudresearch.com/resources/blog/who-uses-amazon-mturk-2020-demographics/

## Final estimate

Give a final estimate of the Wharton audience size in January 2014. Assume that the sample is a random sample of the MTURK population, and that the proportion of Wharton listeners vs. Sirius listeners in the general population is the same as that in the MTURK population. Write a brief executive summary to summarize your findings and how you came to that conclusion.

To be specific, you should include:

1. Goal of the study
2. Method used: data gathering, estimation methods
3. Findings
4. Limitations of the study. 


```{r reachmodel, echo=TRUE, message=FALSE, warning=FALSE}
numhouseholds <- 123.23 #statistia 2014 

# https://www.statista.com/statistics/183635/number-of-households-in-the-us/

avghhsize <- 2.54

# https://www.statista.com/statistics/183648/average-size-of-households-in-the-us/

incomeratedf <- incomeratedf %>% mutate(hhcount = c(15657, 
20007,
22579,
21227,
31034,
14081
))
# https://en.wikipedia.org/wiki/Household_income_in_the_United_States#Distribution_of_household_income_in_2014_according_to_US_Census_data

incomeratedf <- incomeratedf %>% mutate(siriushhs = siriuspct*hhcount)

```

## (2.3) Final estimate Response
1. The Goal of this study is to estimate the Wharton audience size in the United States by using the sample data from the MTURK population. This study operates under two critical limiting assumptions- the sample is a random sample of the MTURK population, and that the proportion of Wharton listeners vs. Sirius listeners in the general population is the same as that in the MTURK population.Thus, the goal of this study is to estimate the audience size of Sirius XM in the United States using the MTURK data, and apply the same proportion of wharton listeners of SiriusXM listeners as MTURK. 

2. The method this study uses to estimate the audience size of the Wharton station, through estimating Sirius XM's audience size, will use different penetration rates across household income buckets. SiriusXM penetration varied along both age and income ranges, but due to limited samples from older age ranges (less than 100 sample points for people over 50 years old), income-varying penetration rates were selected for estimating SiriusXM's reach. Having far more data points for different income buckets representing the vast majority of the US Population (only around 10% of the population was in households with income greater than 150k). Using data from the US Census Bureau, the number of households in each income bracket can be found. Using this methodology, a total number of SiriusXM listening households is found. Combining this with the average household size in 2014 and the penetration of Wharton compared to SiriusXM found in the MTRURK data, a total audience estimation for the Wharton channel is estimated.


3. From this data set and the above explained methodology, the Wharton channel's audiance is estimated to be 12.3 million people, or around 3.8% of the 2014 US Population.

```{r q1finalresults, echo=TRUE, message=FALSE, warning=FALSE}
whartonaudiance <- sum(incomeratedf$siriushhs) * avghhsize * 1000 * whartonpctofsirius
whartonaudiance

estpct <- whartonaudiance / (318400*1000)
estpct
```


4. The greatest limitation to this study is the "income wharton listeining propensity homogeneity" introduced by the limiting assumption in the problem. When we remove this limiting assumption, the audiance size increases by around 50% because wealthier households have a higher propensity to listen to the Wharton channel. Further limitations include a constant household size across income brackets and not considering the impact of age.



## New task

Now suppose you are asked to design a study to estimate the audience size of Wharton Business Radio Show as of today: You are given a budget of $1000. You need to present your findings in two months. 

Write a proposal for this study which includes:

1. Method proposed to estimate the audience size.
2. What data should be collected and where it should be sourced from.
Please fill in the google form to list your platform where surveys will be launched and collected [HERE](https://forms.gle/8SmjFQ1tpqr6c4sa8) 

A good proposal will give an accurate estimation with the least amount of money used. 


1. Google Display Network ads paid per-click on general population websites (news) or a balanced approach to gender segments (sports, cooking recipe sites) and second order organic referrals to the form.

2. To estimate the Wharton audience size, we must reach SiriusXM listeners. Doing this direct, though ads on SiriusXM stations is prohibitively expensive-- SiriusXM requires a minimum monthly spend of 10,000. [1](https://howtoadvertiseonsiriusxm.com/how-much-does-it-cost-to-advertise-on-sirius-xm/) Alternatively, and cheaper, we could run ads drawing only SiriusXM listeners through Google Banner Ads. Running an ad asking website viewers to "vote on new SiriusXM Channels," paying on a cost-per-click basis, would ensure most people who click the ad listen to SiriusXM. On top of paid inbound traffic, the top of the linked form would include an easy to share feature so all users, especially mobile users, could forward the link to their friends that listen to SiriusXM. This would create a second, free, organic traffic source. People would be motivated to share the survey under the belief that this directly influences future SiriusXM channels. In the survey, we would first ask for the desired information, and sneak in "do you listen to the Wharton channel" in the middle. The cost-per-click on the google display network is under 1 dollar for most industries, so we would likely generate around 1000 clicks to the survey. From there a portion would fill it out, and a smaller portion would share with friends. With enough organic referrals, under the guise that respondents are impacting future channel lineups, the survey would likely generate over 1000 data points of people interested in changing SiriusXM's lineup, a population likely resembling the underlying SiriusXM listening base.

Perhaps the largest challenge in estimating Wharton's reach is collecting enough data points for the upper income buckets since these were observed to be more likely to listen to the channel. By promising a non-monetary benefit that they would value, like influencing new channels, this could possibly reach these wealthier demographics. Organic referrals within these demographics would strengthen this method's reach of richer individuals.

CPC for Google Ads: https://www.webfx.com/blog/marketing/much-cost-advertise-google-adwords/ 





# Case study 2: Women in Science


Are women underrepresented in science in general? How does gender relate to the type of educational degree pursued? Does the number of higher degrees increase over the years? In an attempt to answer these questions, we assembled a data set (`WomenData_06_16.xlsx`) from [NSF](https://ncses.nsf.gov/pubs/nsf19304/digest/field-of-degree-women) about various degrees granted in the U.S. from 2006 to 2016. It contains the following variables: Field (Non-science-engineering (`Non-S&E`) and sciences (`Computer sciences`, `Mathematics and statistics`, etc.)), Degree (`BS`, `MS`, `PhD`), Sex (`M`, `F`), Number of degrees granted, and Year.

Our goal is to answer the above questions only through EDA (Exploratory Data Analyses) without formal testing. We have provided sample R-codes in the appendix to help you if needed. 


## Data preparation  

1. Understand and clean the data

Notice the data came in as an Excel file. We need to use the package `readxl` and the function `read_excel()` to read the data `WomenData_06_16.xlsx` into R. 


i. Read the data into R.
ii. Clean the names of each variables. (Change variable names to  `Field`,`Degree`, `Sex`, `Year` and `Number` )
iii. Set the variable natures properly. 
iv. Any missing values?

There are no missing values.

```{r question3.1.1, echo=TRUE, message=FALSE, warning=FALSE}
womendata <- read_excel("data/WomenData_06_16.xlsx")
womendata <- womendata %>% rename(Field = "Field and sex", 
                                  Degree = "Degree", Sex = "Sex", 
                                  Year = "Year", 
                                  Number = "Degrees Awarded")
womendata %<>% 
  mutate(Field = as.factor(Field), Degree = as.factor(Degree), Sex = as.factor(Sex))

which(is.na(womendata$Field))
which(is.na(womendata$Degree))
which(is.na(womendata$Sex))
which(is.na(womendata$Year))
which(is.na(womendata$Number))

summary(womendata)
```

2. Write a summary describing the data set provided here. 

i. How many fields are there in this data?
```{r question3.1.2.i, echo=TRUE, message=FALSE, warning=FALSE}
length(unique(womendata$Field))
```
ii. What are the degree types? 
```{r question3.1.2.ii, echo=TRUE, message=FALSE, warning=FALSE}
unique(womendata$Degree)
```
iii. How many year's statistics are being reported here? 
```{r question3.1.2.iii, echo=TRUE, message=FALSE, warning=FALSE}
length(unique(womendata$Year))
```


## BS degrees in 2015

Is there evidence that more males are in science-related fields vs `Non-S&E`? Provide summary statistics and a plot which shows the number of people by gender and by field. Write a brief summary to describe your findings.

```{r question3.2.1, echo = TRUE, message=FALSE, warning=FALSE}
womendataBS2015 <- filter(womendata, Degree == "BS" & Year == 2015)
womendataBS2015 %>%
  mutate(SE = ifelse(Field!="Non-S&E" , "S&E", "Non-S&E")) %>%
  group_by(SE, Sex) %>%
  summarise(SE_number = sum(Number)) %>%
  ggplot(aes(x = SE, y = SE_number, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme(axis.text.y = element_text(angle = 60)) +
  ggtitle("Degrees granted by S&E vs non-S&E by gender")

womendataBS2015 %>%  
  group_by(Sex) %>%
  summarise(deg = mean(Number))
```

First, it is important to note that there are more females than males in this dataset (2015, BS).

```{r question3.2.2, echo=TRUE, message=FALSE, warning=FALSE}
womendataBS2015 %>%  # to get the average number of ppl by gender
  group_by(Field, Sex) %>%
  summarise(deg = mean(Number))

womendataBS2015 %>%
  ggplot(aes(x = Field, y = Number, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(Degree~., scales = "free_y") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  ggtitle("Degrees granted across fields by degree and gender") 
```

We plot the absolute number of people by gender and by field. As expected by the fact that there are more women in the dataset, there are more females in non-S&E fields than men. However, there are more men in select fields such as Math & Statistics, Physical Sciences, Earch/Atmospheric/Ocean Sciences, Computer Sciences, and Engineering.

```{r question3.2.3, echo=TRUE, message=FALSE, warning=FALSE}
womendata %>%
  filter(Degree == "BS" & Year == 2015)  %>%
  mutate(SE = ifelse(Field!="Non-S&E" , "S&E", "Non-S&E")) %>%
  group_by(SE, Sex, Year) %>%
  summarise(SE_number = sum(Number)) %>%
  group_by(SE, Year) %>%
  mutate(ratio = SE_number / sum(SE_number)) %>%
  filter(Sex == "Female")
```

Charting the ratio of females in Non-S&E and S&E fields, we can see that there is not sufficient evidence of more males in either degree type. In fact, there are more females in non-S&E fields, and an approximately equal gender ratio in S&E fields.

## EDA bringing type of degree, field and gender in 2015

Describe the number of people by type of degree, field, and gender. Do you see any evidence of gender effects over different types of degrees? Again, provide graphs to summarize your findings.

```{r question3.3.1, echo=TRUE, message=FALSE, warning=FALSE}
womendata %>%
  filter(Year == 2007) %>%
  ggplot(aes(x = Field, y = Number, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(Degree~., scales = "free_y") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  ggtitle("Degrees granted across fields by degree and gender") 
```

Across all 3 degrees, we see more females than males in non-S&E fields. Some noticeable differences across degrees is that there are more males in Social Sciences at the PHD level, but more females in Social Sciences at the MS and  BS levels. Similarly, the discrepancy (more males than females) is more noticeable at the PHD level in Engineering and Computer Sciences fields.

## EDA bring all variables 

In this last portion of the EDA, we ask you to provide evidence numerically and graphically: Do the number of  degrees change by gender, field, and time? 

```{r, echo = F}
print_output <- function(output, cex = 0.7) {
  tmp <- capture.output(output)
  plot.new()
  text(0, 1, paste(tmp, collapse='\n'), adj = c(0,1), family = 'mono', cex = cex)
  box()
}
```

```{r question3.4, echo=TRUE, message=FALSE, warning=FALSE}
plot3.4 <- ggplot(womendata, aes(x = Year, y = Number, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(Field~Degree, scales = "free_y") +
  ggtitle("Degrees granted pr option by sex across degree and SE")
plot3.4
print_output(ggplot_build(plot3.4)$data[[1]])
```

Here, we have graphed visually and numerically (by extracting the ggplot data) the number of degrees across gender (bar color), field, and time (x-axis). First, we discuss the changes over time. The number of degrees generally has a slight increase over time, which is more prominent at the BS level. Across genders, males still have a larger number of total degrees, and this dispartiy is most  prominent in Engineering and Computer Science fields. This disparity has not been alleviated over the time, despite growing number of degrees in both genders. The fields with largely more females are still Psychology, Non-S&E, etc., which further supprots the lack of representation of women in STEM fields.

## Women in Data Science

Finally, is there evidence showing that women are underrepresented in data science? Data science is an interdisciplinary field of computer science, math, and statistics. You may include year and/or degree.

```{r question3.5, echo=TRUE, message=FALSE, warning=FALSE}
womendata %>%
  filter(Field == "Computer sciences" | Field == "Mathematics and statistics") %>%
  # mutate(SE = ifelse(Field!="Non-S&E" , "S&E", "Non-S&E")) %>%
  group_by(Field, Sex, Year, Degree) %>%
  summarise(SE_number = sum(Number)) %>%
  group_by(Field, Year, Degree) %>%
  mutate(ratio = SE_number / sum(SE_number)) %>%
  filter(Sex == "Female") %>%
  ggplot(aes(x = Year, y = ratio, color = Field)) +
  geom_point() + geom_line() +
  facet_grid(~Degree)+
  ggtitle("Female proportion in Data Science across year by degree")


womendata %>%
  filter(Field == "Computer sciences" | Field == "Mathematics and statistics") %>%
  # mutate(SE = ifelse(Field!="Non-S&E" , "S&E", "Non-S&E")) %>%
  group_by(Field, Sex, Year, Degree) %>%
  summarise(SE_number = sum(Number)) %>%
  ggplot(aes(x = Year, y = SE_number, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(Field~Degree, scales = "free_y") +
  ggtitle("Degrees granted by sex, degree and field")


womendata %>%
  filter(Field == "Computer sciences" | Field == "Mathematics and statistics") %>%
  # mutate(SE = ifelse(Field!="Non-S&E" , "S&E", "Non-S&E")) %>%
  group_by(Field, Sex, Year, Degree) %>%
  summarise(SE_number = sum(Number)) %>%
  ggplot(aes(x = Year, y = SE_number, fill = Sex)) +
  geom_bar(stat = "identity", position = "fill") +
  facet_grid(Field~Degree, scales = "free_y") +
  ggtitle("Degrees granted proportion by sex across degree and Field")
```

From the line graph of the female proportion in data science across year by degree, we see that in all 3 degrees (BS, MS, PHD), and both subfields of data science (CS, Math and Stats), we see the female proportion is significantly lower than males. This difference is especially pronounced in the Bachelors degree, without more than double the men than women. Furthermore, this problem is not fixed over time, except potentially in the Masters degree, with increasing female proportion in specifiically Computer Science. The bar charts support this claim, but give absolute numbers rather than the proportion.

## Final brief report

Summarize your findings focusing on answering the questions regarding if we see consistent patterns that more males pursue science-related fields. Any concerns with the data set? How could we improve on the study?

As mentioned in the first part of this case problem, one concern of the dataset is that there is a class imbalance. Specificially, there are more females in the datset, and more datapoints in the non-S&E, computer sciences, and engineering fields, as these are more popular fields/majors. To improve this class imbalance, undersampling the heavy classes or collecting more datapoints on the lighter classes could be used.

Looking past the large number of famles in the dataset, we first focused our analysis on Bachelors degree in 2015. THere were more women than men in certain non STEM fields. Expanding the analysis to other degrees, we see similar results at the Masters and PHD levels, although there are fewer number of people with those degree levels. Expanding the anlaysis once more time to inlcude all years, we see that more people are receiving degrees at all 3 levels over time. However, the gender difference is not alleviated over time, especiall in Engineering, Computer Science, and Math/Statistics fields. 

## Appendix

To help out, we have included some R-codes here as references. You should make your own chunks filled with texts going through each items listed above. Make sure to hide the unnecessary outputs/code etc. 

1. Clean data

```{r data wrangling, eval=FALSE, warning=FALSE, include=FALSE}
# For the demonstration purpose, we show this R-chunk by taking echo=TRUE
# In your final report you should hide all the R-chunks to keep your report flowing well.
wsci <- read_excel("data/WomenData_06_16.xlsx")
names(wsci)
head(wsci)
#change names
wsci %<>% 
  rename(Field = 'Field and sex')
# set the field, degree and sex as factors
wsci %<>% 
  mutate( Field = as.factor(Field))
```


```{r eval=FALSE, include=FALSE}
# wsci %<>%
#   rename(Field = "Field and sex",
#          Number = "Degrees Awarded") %>%
#   mutate(Field = as.factor(Field),
#          Degree = as.factor(Degree),
#          Sex = as.factor(Sex))

```


2. A number of sample analyses 

```{r eval=FALSE, include=FALSE}
wsci %>%  # to get the average number of ppl by gender
  group_by(Field, Sex) %>%
  summarise(deg = mean(Number))

wsci %>%
  filter(Year == 2007) %>%
  ggplot(aes(x = Field, y = Number, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(Degree~., scales = "free_y") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  ggtitle("Degrees granted across fields by degree and gender") 

wsci %>%
  mutate(SE = ifelse(Field!="Non-S&E" , "S&E", "Non-S&E")) %>%
  group_by(SE, Sex) %>%
  summarise(SE_number = sum(Number)) %>%
  ggplot(aes(x = SE, y = SE_number, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme(axis.text.y = element_text(angle = 60)) +
  ggtitle("Degrees granted by S&E vs non-S&E by gender")

wsci %>%
  mutate(SE = ifelse(Field!="Non-S&E" , "S&E", "Non-S&E")) %>%
  group_by(SE, Sex, Year) %>%
  summarise(SE_number = sum(Number)) %>%
  group_by(SE, Year) %>%
  mutate(ratio = SE_number / sum(SE_number)) %>%
  filter(Sex == "Female") %>%
  ggplot(aes(x = Year, y = ratio, color = SE)) +
  geom_point() + geom_line() +
  ggtitle("Female proportion in SE/non-SE across year")

wsci %>%
  mutate(SE = ifelse(Field!="Non-S&E" , "S&E", "Non-S&E")) %>%
  group_by(SE, Sex, Year, Degree) %>%
  summarise(SE_number = sum(Number)) %>%
  group_by(SE, Year, Degree) %>%
  mutate(ratio = SE_number / sum(SE_number)) %>%
  filter(Sex == "Female") %>%
  ggplot(aes(x = Year, y = ratio, color = SE)) +
  geom_point() + geom_line() +
  facet_grid(~Degree)+
  ggtitle("Female proportion in SE/non-SE across year by degree")


wsci %>%
  mutate(SE = ifelse(Field!="Non-S&E" , "S&E", "Non-S&E")) %>%
  group_by(SE, Sex, Year, Degree) %>%
  summarise(SE_number = sum(Number)) %>%
  ggplot(aes(x = Year, y = SE_number, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(SE~Degree, scales = "free_y") +
  ggtitle("Degrees granted by sex, degree and SE")


wsci %>%
  mutate(SE = ifelse(Field!="Non-S&E" , "S&E", "Non-S&E")) %>%
  group_by(SE, Sex, Year, Degree) %>%
  summarise(SE_number = sum(Number)) %>%
  ggplot(aes(x = Year, y = SE_number, fill = Sex)) +
  geom_bar(stat = "identity", position = "fill") +
  facet_grid(SE~Degree, scales = "free_y") +
  ggtitle("Degrees granted proportion by sex across degree and SE")


wsci %>%
  filter(Field %in% c("Computer sciences", "Mathematics and statistics")) %>%
  ggplot(aes(x = Year, y = Number, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(Field~Degree, scales = "free_y") +
  ggtitle("Degrees granted pr option by sex across degree and SE")


wsci %>%
  ggplot(aes(x = Year, y = Number, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(Field~Degree, scales = "free_y") +
  ggtitle("Degrees granted proportion by sex across degree and SE")
```




# Case study 3: Major League Baseball

We would like to explore how payroll affects performance among Major League Baseball teams. The data is prepared in two formats record payroll, winning numbers/percentage by team from 1998 to 2014. 

Here are the datasets:

-`MLPayData_Total.csv`: wide format
-`baseball.csv`: long format

Feel free to use either dataset to address the problems. 

## EDA: Relationship between payroll changes and performance

Payroll may relate to performance among ML Baseball teams. One possible argument is that what affects this year's performance is not this year's payroll, but the amount that payroll increased from last year. Let us look into this through EDA. 

Create increment in payroll

i. To describe the increment of payroll in each year there are several possible approaches. Take 2013 as an example:

    - option 1: diff: payroll_2013 - payroll_2012
    - option 2: log diff: log(payroll_2013) - log(payroll_2012)
```{r, echo=TRUE, message=FALSE, warning=FALSE}
baseball<-read.csv("data/MLPayData_Total.csv")
names(baseball)
```
Explain why the log difference is more appropriate in this setup.

The logarithmic is helpful when the data covers an extensive range of values. Using the logarithms of the values rather than the actual values reduces a wide range to a more manageable size. In the case of this dataset, most baseball teams’ total payroll more than quadrupled for 16 years. Without doing the logarithmic transformation, the increases in payroll would seem much more significant in the later years than the beginning years, potentially skewing the results of our regression and PCA analysis results. Therefore, taking the log difference is way more appropriate in this setup.

ii. Create a new variable `diff_log=log(payroll_2013) - log(payroll_2012)`. Hint: use `dplyr::lag()` function.
```{r, echo=TRUE, message=FALSE, warning=FALSE}
diff_log = log(baseball[3:18]) - log(baseball[2:17])
combined <- cbind(baseball,diff_log)
dim(combined)
filtered1 = cbind(combined[1],combined[36:52])
filtered2 = cbind(combined[1],combined[53:68])
filtered3 = cbind(combined[1],combined[2:18])
```

iii. Create a long data table including: team, year, diff_log, win_pct
```{r, echo=TRUE, message=FALSE, warning=FALSE}
long_filtered1 = filtered1 %>% pivot_longer(!Team.name.2014, names_to =  "year", 
                                            names_prefix = "X", values_to = "win_pct")
long_filtered2 = filtered2 %>% pivot_longer(!Team.name.2014, names_to =  "year", 
                                            names_prefix = "p", values_to = "diff_log")
olClean <- function(x){
    x <- str_remove(x,".pct")
}
long_filtered3 = filtered3 %>% pivot_longer(!Team.name.2014, names_to =  "year", 
                                            names_prefix = "p", values_to = "total_pay")
long_filtered1["year"] = sapply(long_filtered1["year"],olClean)
Final_df = full_join(long_filtered1,long_filtered2,by = c("Team.name.2014","year"))
Final_df = full_join(Final_df,long_filtered3,by = c("Team.name.2014","year"))
names(Final_df)[names(Final_df) == 'Team.name.2014'] <- 'Team'
head(Final_df)
summary(Final_df)
```
## Exploratory questions

i. Which five teams had highest increase in their payroll between years 2010 and 2014, inclusive?
```{r, echo=TRUE, message=FALSE, warning=FALSE}
explore1 <- combined[,c("Team.name.2014","X2010","X2014")]
explore1["payroll"] = explore1["X2010"] - explore1["X2014"]
library(dplyr)
arrange(explore1,payroll)
```

Pirates, Orioles, Nationals, Mariners, Royals.

ii. Between 2010 and 2014, inclusive, which team(s) "improved" the most? That is, had the biggest percentage gain in wins?
```{r, echo=TRUE, message=FALSE, warning=FALSE}
explore2 <- combined[,c("Team.name.2014","X2010.pct","X2014.pct")]
explore2["win"] = combined["X2010.pct"] - combined["X2014.pct"]
library(dplyr)
arrange(explore2,win)
```

Pirates, Orioles, Nationals, Mariners, Royals etc. improved the most with the highest percentage gain in wins.

## Do log increases in payroll imply better performance? 

Is there evidence to support the hypothesis that higher increases in payroll on the log scale lead to increased performance?

Pick up a few statistics, accompanied with some data visualization, to support your answer. 

**From the graph below, we see that there is evidence to support the hypothesis that higher increase in payroll on the log scale leads to higher performance. This is supported by a positive coefficient with a t-value of 3.7 that is statistically significant. **

```{r, echo=TRUE, message=FALSE, warning=FALSE}
Final_df %>% ggplot() + aes(x = diff_log, y = win_pct) + geom_point() + 
  geom_smooth(method='lm', formula= y~x)
#Final_df %>% ggplot() + aes(x = diff_log, y = win_pct) + geom_point()
#ggplot(data = Final_df, x = "diff_log", y = "win_pct")
simple.fit = lm(win_pct ~ diff_log, data = Final_df)
summary(simple.fit)
```
## Comparison

Which set of factors are better explaining performance? Yearly payroll or yearly increase in payroll? What criterion is being used? 

```{r, echo=TRUE, message=FALSE, warning=FALSE}

Final_df %>%
  ggplot(aes(x=total_pay, y=win_pct, group = year, color=Team)) +
  geom_point()+
  geom_smooth(method="lm", formula=y~x, se=F,color = "red")+
  facet_wrap(~year) + 
  theme_bw() +
  theme(legend.position = 0)


Final_df %>%
  ggplot(aes(x=diff_log, y=win_pct, group = year, color=Team)) +
  geom_point()+
  geom_smooth(method="lm", formula=y~x, se=F,color = "red")+
  facet_wrap(~year) + 
  theme_bw() +
  theme(legend.position = 0)
```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
simple.fit = lm(win_pct ~ diff_log, data = Final_df)
summary(simple.fit)

simple.fit = lm(win_pct ~ total_pay, data = Final_df)
summary(simple.fit)
```

Based on the line graphs, there is strong evidenece that yearly pay roll is better at explaining performance, based on the positive correlations throughout the years. This conclusion is supported by the fact the R^2 is higher for total pay than diff log. Furthermore, the t-value of 8.3 and p-value for total_pay is more statistically significant. Meanwhile, there are some years where the regression fit for diff_log and win_pct are negative, for example, 2014.
